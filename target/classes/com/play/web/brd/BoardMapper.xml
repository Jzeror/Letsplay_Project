<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.play.web.brd.BoardMapper">
<resultMap id="seinResult" type="hashmap">
	<result property="msg_seq" column="MSG_SEQ"/>
	<result property="msg_title" column="MSG_TITLE"/>
	<result property="msg_photo" column="MSG_PHOTO"/>
	<result property="msg_date" column="MSG_DATE"/>
	<result property="msg_count" column="MSG_COUNT"/>
	<result property="msg_content" column="MSG_CONTENT"/>
	<result property="bookmark_count" column="BOOKMARK_COUNT"/>
	<result property="subscription_count" column="SUBSCRIPTION_COUNT"/>
	<result property="board_depth" column="BOARD_DEPTH"/>
	<result property="board_id" column="BOARD_ID"/>
	<result property="member_id" column="MEMBER_ID"/>
	<result property="pay_no" column="PAY_NO"/>
	<result property="tag" column="TAG"/>
	<result property="like_count" column="LIKE_COUNT"/>
	<result property="reply_count" column="REPLY_COUNT"/>
	<result property="accom_grade" column="ACCOM_GRADE"/>
	<result property="accom_reco" column="ACCOM_RECO"/>
	<result property="reply_seq" column="REPLY_SEQ"/>
	<result property="msg_ref" column="MSG_REF"/>
	<result property="nickname" column="NICKNAME"/>
	<result property="password" column="NICKpasswordNAME"/>
	<result property="birthdate" column="BIRTHDATE"/>
	<result property="joindate" column="JOINDATE"/>
	<result property="gender" column="GENDER"/>
	<result property="age" column="AGE"/>
	<result property="phone" column="PHONE"/>
	<result property="customer_grade" column="CUSTOMER_GRADE"/>
	<result property="point" column="POINT"/>
	<result property="address" column="ADDRESS"/>
	<result property="zipcode" column="ZIPCODE"/>
	<result property="profileimg" column="PROFILEIMG"/>
	<result property="like_check" column="LIKE_CHECK"/>
	<result property="bookmark_check" column="BOOKMARK_CHECK"/>
	<result property="saved_uinque" column="SAVED_UINQUE"/>
</resultMap>

  <insert id="write">
   INSERT INTO board (MSG_TITLE, MSG_CONTENT, BOARD_ID, MEMBER_ID, TAG, MSG_PHOTO)
   VALUES (#{msg_title}, #{msg_content}, #{board_id}, #{member_id}, #{tag}, #{msg_photo}) 
  </insert>
  
  <select id="list" resultMap="seinResult">
	SELECT *
       FROM (
           SELECT
               ROW_NUMBER() OVER(ORDER BY msg_seq DESC) AS NUM,
               a.*, m.NICKNAME, m.PROFILEIMG
           FROM board a
           	JOIN member m
           	ON a.MEMBER_ID = m.MEMBER_ID
           WHERE a.board_depth like 0
           AND a.board_id like #{board_id}
           <if test="member_id != null">
           		AND a.MEMBER_ID like #{member_id}
           </if>
       )B
       WHERE B.NUM BETWEEN #{beginRow} AND #{endRow}
       ORDER BY B.NUM
  </select>
  
  <select id="read" resultMap="seinResult">
  	SELECT a.*, m.nickname, m.profileimg
  	FROM board a
	  	JOIN member m
	    ON a.MEMBER_ID = m.MEMBER_ID
  	WHERE a.MSG_SEQ like #{msg_seq}
  </select>
  
  <update id="modify">
  	UPDATE board SET MSG_TITLE=#{msg_title}, MSG_CONTENT=#{msg_content}, TAG=#{tag}
  	WHERE BOARD_ID LIKE #{board_id}
  	AND MSG_SEQ LIKE #{msg_seq}
  </update>
  
  <delete id="delete">
  	DELETE FROM board
  	WHERE BOARD_ID LIKE #{board_id}
  	AND MSG_SEQ LIKE #{msg_seq}
  </delete>
  
  <insert id="reWrite">
  	INSERT INTO board (MSG_CONTENT,BOARD_DEPTH, MSG_REF, BOARD_ID, MEMBER_ID, REPLY_SEQ)
  	VALUES (#{msg_content},#{board_depth}, #{msg_seq}, #{board_id}, #{member_id}, 
  		nvl((SELECT MAX(REPLY_SEQ)+1
  		FROM board b
 		WHERE BOARD_ID LIKE #{board_id}
  		AND BOARD_DEPTH LIKE #{board_depth}
  		AND MSG_REF LIKE #{msg_seq}
  		),1)
  	)
  </insert>
  
  <select id="reply" resultMap="seinResult">
	SELECT *
       FROM (
           SELECT
               ROW_NUMBER() OVER(ORDER BY msg_seq DESC) AS NUM,
               A.*, M.NICKNAME, M.PROFILEIMG
           FROM
               board A
               JOIN member M
               ON A.member_id like M.member_id
           WHERE msg_ref like #{msg_ref}
           AND board_id like #{board_id}
           AND board_depth like #{board_depth}
       )B
  </select>
  
  <update id="reModify">
  	UPDATE board SET MSG_CONTENT=#{msg_content}
  	WHERE BOARD_ID LIKE #{board_id}
  	AND MSG_SEQ LIKE #{msg_seq}
  </update>
  
  <delete id="reDelete">
  	DELETE FROM board 
  	WHERE BOARD_ID LIKE #{board_id}
  	AND MSG_SEQ LIKE #{msg_seq}
  </delete>
    
  <select id="count" resultType="int">
  	SELECT COUNT(*) FROM board
  	WHERE board_depth like 0
  	AND board_id like 'cast'
  	<if test=" member_id != null and member_id != ''">
  	AND member_id like #{member_id};
  	</if>
  </select>
  
  <update id="readInc">
  	UPDATE board SET MSG_COUNT=MSG_COUNT+1
  	WHERE MSG_SEQ LIKE #{msg_seq}
  </update>
  
  <update id="likeInc">
  	UPDATE board SET LIKE_COUNT=LIKE_COUNT+1
  	WHERE MSG_SEQ LIKE #{msg_seq}
  </update>
  
  <update id="likeDes">
  	UPDATE board SET LIKE_COUNT=LIKE_COUNT-1
  	WHERE MSG_SEQ LIKE #{msg_seq}
  </update>
  
  <insert id="saveLike">
  	INSERT INTO saved_accom (SAVED_UNIQUE, MEMBER_ID, MSG_SEQ, LIKE_CHECK)
  	VALUES (#{saved_unique}, #{member_id}, #{msg_seq}, 1)
  	ON DUPLICATE KEY UPDATE LIKE_CHECK=1
  </insert>
  
  <insert id="deleteLike">
  	UPDATE saved_accom SET LIKE_CHECK=0
  	WHERE SAVED_UNIQUE LIKE #{saved_unique}
  </insert>
  
  <insert id="room">
  	INSERT INTO ROOM (ACCOM_SEQ, ROOM_NAME, ROOM_NO, ROOM_PRICE)
  	VALUES (#{accom_seq},#{room_name},#{room_no},#{room_price})
  </insert>
  
  <select id="check" resultMap="seinResult">
	SELECT *
	FROM saved_accom
	WHERE MSG_SEQ LIKE #{msg_seq}
	AND MEMBER_ID LIKE #{member_id}
  </select>
</mapper>
